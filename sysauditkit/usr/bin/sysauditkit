#!/bin/bash

CONF_DIR="/etc/sysauditkit"
CONF_FILE="$CONF_DIR/owner.conf"
LOG_DIR="/var/log/sysauditkit"
LOG_FILE="$LOG_DIR/sysaudit.log"

if [ "$EUID" -ne 0 ]; then
  echo "Error: This tool must be run as root (sudo)."
  exit 1
fi

mkdir -p "$LOG_DIR"

log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# ==========================================
# MODULE: HELP
# ==========================================
show_help() {
    echo "Usage: sysauditkit [command]"
    echo "Commands:"
    echo "  init     - Initialize system (create user, set permissions)"
    echo "  report   - Generate system report"
    echo "  search   - Search and analyze files"
    echo "  monitor  - Monitor and manage processes"
    echo "  help     - Show this help message"
}

# ==========================================
# MODULE: INIT
# ==========================================
run_init() {
    echo "--- System Initialization ---"
    
    read -p "Enter Student First Name: " PRENOM
    read -p "Enter Student Last Name: " NOM

    mkdir -p "$CONF_DIR"

    USER_ID="${PRENOM,,}.${NOM,,}"
    WORK_DIR="/home/$USER_ID/work"

    echo "OWNER_NAME=$PRENOM" > "$CONF_FILE"
    echo "OWNER_SURNAME=$NOM" >> "$CONF_FILE"
    echo "USER_ID=$USER_ID" >> "$CONF_FILE"
    echo "WORK_DIR=$WORK_DIR" >> "$CONF_FILE"

    if id "$USER_ID" &>/dev/null; then
        echo "User $USER_ID already exists."
        log_action "User $USER_ID already exists"
    else
        useradd -m -s /bin/bash "$USER_ID"
        echo "User $USER_ID created."
        log_action "User $USER_ID created"
    fi

    mkdir -p "$WORK_DIR"
    chown "$USER_ID":"$USER_ID" "$WORK_DIR"
    chmod 700 "$WORK_DIR"

    echo "Work directory created at $WORK_DIR"
    log_action "Work directory initialized for $USER_ID"
}

# ==========================================
# MODULE: REPORT
# ==========================================
run_report() {
    if [ -f "$CONF_FILE" ]; then
        source "$CONF_FILE"
        REPORT_FILE="$WORK_DIR/report_${USER_ID}_$(date +%F).txt"
    else
        REPORT_FILE="report_system_$(date +%F).txt"
    fi

    echo "Generating report to $REPORT_FILE..."

    cat <<EOF > "$REPORT_FILE"
===================================================
             SYSAUDITKIT SYSTEM REPORT
===================================================
Generated by: ${OWNER_NAME:-System} ${OWNER_SURNAME:-Admin}
Identifier: ${USER_ID:-N/A}
Date: $(date)
===================================================
EOF

    echo -e "\n--- SYSTEM INFO ---" >> "$REPORT_FILE"
    uname -a >> "$REPORT_FILE"

    echo -e "\n--- DISK USAGE ---" >> "$REPORT_FILE"
    df -h >> "$REPORT_FILE"

    echo -e "\n--- CONNECTED USERS ---" >> "$REPORT_FILE"
    who >> "$REPORT_FILE"

    echo -e "\n--- TOP CPU PROCESSES ---" >> "$REPORT_FILE"
    ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%cpu | head -n 6 >> "$REPORT_FILE"

    log_action "System report generated at $REPORT_FILE"
    echo "Report generated successfully."
}

# ==========================================
# MODULE: SEARCH
# ==========================================
run_search() {
    source "$CONF_FILE" 2>/dev/null

    if [ -z "$WORK_DIR" ]; then
        echo "Error: WORK_DIR not defined. Run 'sysauditkit init' first."
        log_action "ERROR: WORK_DIR undefined"
        return 1
    fi

    read -p "Directory to search: " SEARCH_DIR
    read -p "File extension (e.g. log): " EXT
    read -p "Keyword(s) to search: " KEYWORDS

    OUTPUT_FILE="$WORK_DIR/search_results.txt"
    if [ ! -d "$SEARCH_DIR" ]; then
        echo "Error: Directory does not exist."
        log_action "ERROR: Directory $SEARCH_DIR not found"
        return 1
    fi

    if [ ! -r "$SEARCH_DIR" ]; then
        echo "Error: Insufficient permissions."
        log_action "ERROR: No permission on $SEARCH_DIR"
        return 1
    fi
    echo "===== FILE SEARCH =====" > "$OUTPUT_FILE"
    find "$SEARCH_DIR" -type f -name "*.$EXT" | tee -a "$OUTPUT_FILE"

    if [ ! -s "$OUTPUT_FILE" ]; then
        echo "No files found."
        log_action "No files found in $SEARCH_DIR"
        return 0
    fi
    echo -e "\n===== CONTENT ANALYSIS =====" >> "$OUTPUT_FILE"
    find "$SEARCH_DIR" -type f -name "*.$EXT" -exec grep -in "$KEYWORDS" {} + >> "$OUTPUT_FILE"

    if [ $? -ne 0 ]; then
        echo "No matching keywords found."
        log_action "No keyword match for '$KEYWORDS'"
    fi

    log_action "Search executed in $SEARCH_DIR"
    echo "Search results saved to $OUTPUT_FILE"
}

# ==========================================
# MODULE: MONITOR
# ==========================================
run_monitor() {
    echo "--- Process Monitor ---"
    read -p "Enter username to monitor: " TARGET_USER

    if ! id "$TARGET_USER" &>/dev/null; then
        echo "Error: User $TARGET_USER does not exist."
        return 1
    fi

    ps -u "$TARGET_USER" -o pid,%cpu,%mem,cmd

    while true; do
        read -p "Enter PID to manage (or q to quit): " PID
        [ "$PID" = "q" ] && break

        read -p "Choose action: (k)ill or (r)enice: " ACTION
        case "$ACTION" in
            k)
                read -p "Confirm kill (y/n): " CONFIRM
                [ "$CONFIRM" = "y" ] && kill -9 "$PID" && log_action "Killed PID $PID"
                ;;
            r)
                read -p "Enter nice value (-20 to 19): " NICE_VAL
                renice "$NICE_VAL" -p "$PID"
                log_action "Reniced PID $PID to $NICE_VAL"
                ;;
            *)
                echo "Invalid action."
                ;;
        esac
    done
}

# ==========================================
# MAIN EXECUTION SWITCH
# ==========================================
case "$1" in
    init)     run_init ;;
    report)   run_report ;;
    search)   run_search ;;
    monitor)  run_monitor ;;
    help|*)   show_help ;;
esac

